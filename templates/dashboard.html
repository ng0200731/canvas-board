{% extends "base.html" %}
{% block title %}Dashboard — Canva Board{% endblock %}
{% block content %}
<div class="dashboard">
    <h2>Your Boards</h2>
    <form class="new-board-form" method="POST" action="{{ url_for('board.create_board') }}">
        <input type="text" name="title" placeholder="New board title..." required>
        <button type="submit">+ Create Board</button>
    </form>
    <div style="margin-bottom:1rem;">
        <input type="text" id="tag-search" placeholder="Search by tag..." style="padding:0.4rem 0.6rem;border:1px solid #000;font-size:0.85rem;width:240px;">
    </div>
    {% if pending_email_count > 0 %}
    <p style="margin-bottom:1rem;font-size:0.9rem;">
        <a href="{{ url_for('email.inbox') }}">{{ pending_email_count }} pending email(s)</a>
    </p>
    {% endif %}
    <div class="board-grid">
        {% for b in boards %}
        <a class="board-card" href="{{ url_for('board.view_board', board_id=b.id) }}" data-board-id="{{ b.id }}">
            <h3>{{ b.title }}</h3>
            <p>{{ b.card_count }} card(s) · {{ b.view_mode }}</p>
            <p>{{ b.updated_at[:10] }}</p>
            <div class="board-image-popup" onclick="event.preventDefault(); event.stopPropagation();">
                <div class="board-image-popup-content">
                    <div class="board-image-loading">Loading...</div>
                </div>
            </div>
        </a>
        {% endfor %}
        {% if not boards %}
        <p style="opacity:0.5;">No boards yet. Create one above.</p>
        {% endif %}
    </div>
</div>
<script>
(function() {
    const input = document.getElementById("tag-search");
    let timeout;
    input.addEventListener("input", () => {
        clearTimeout(timeout);
        timeout = setTimeout(async () => {
            const q = input.value.trim();
            const cards = document.querySelectorAll(".board-card");
            if (!q) {
                cards.forEach(c => {
                    c.style.display = "";
                    c.setAttribute("href", c.getAttribute("href").split("?")[0]);
                });
                return;
            }
            const res = await fetch(`/api/search/tags?q=${encodeURIComponent(q)}`);
            const data = await res.json();
            const matchIds = new Set(data.boards.map(b => b.id));
            cards.forEach(c => {
                c.style.display = matchIds.has(c.dataset.boardId) ? "" : "none";
                // Append ?tag= to board links so the board page can auto-highlight
                const base = c.getAttribute("href").split("?")[0];
                c.setAttribute("href", base + "?tag=" + encodeURIComponent(q));
            });
        }, 300);
    });

    // Load images on hover
    const boardCards = document.querySelectorAll(".board-card");
    const loadedBoards = new Set();

    boardCards.forEach(card => {
        card.addEventListener("mouseenter", async () => {
            const boardId = card.dataset.boardId;
            if (loadedBoards.has(boardId)) return;

            loadedBoards.add(boardId);
            const popup = card.querySelector(".board-image-popup-content");
            const loading = popup.querySelector(".board-image-loading");

            try {
                const res = await fetch(`/api/boards/${boardId}/images`);
                const data = await res.json();
                console.log("Board images data:", data);

                // Remove loading indicator
                if (loading) loading.remove();

                if (data.images && data.images.length > 0) {
                    const grid = document.createElement("div");
                    grid.className = "board-image-popup-grid";
                    data.images.forEach(img => {
                        const imgEl = document.createElement("img");
                        imgEl.src = img.thumb_url;
                        imgEl.alt = img.original_name;
                        imgEl.title = img.original_name;
                        grid.appendChild(imgEl);
                    });
                    popup.appendChild(grid);
                } else {
                    const empty = document.createElement("div");
                    empty.className = "board-image-popup-empty";
                    empty.textContent = "No images";
                    popup.appendChild(empty);
                }
            } catch (e) {
                console.error("Failed to load board images:", e);
                if (loading) loading.textContent = "Failed to load";
            }
        });
    });
})();
</script>
{% endblock %}
